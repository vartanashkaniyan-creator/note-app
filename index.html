<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø§Ù¾ Ù¾ÛŒØ´Ø±ÙØªÙ‡ | Advanced App Builder</title>
  <style>
    /* ===== RESET & BASE ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { min-height:100vh; background:#121212; color:#e0e0e0; font-family: 'Segoe UI', sans-serif; }
    html[dir="rtl"] { direction: rtl; text-align: right; }
    html[dir="ltr"] { direction: ltr; text-align: left; }

    /* ===== HEADER ===== */
    .header-bar { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#1e1e1e; }
    #languageSelect { padding:5px 10px; border-radius:5px; background:#2a2a2a; color:#fff; border:1px solid #444; cursor:pointer; }
    .debug-btn { padding:5px 10px; background:#333; color:#888; border:none; cursor:pointer; }

    /* ===== APP ===== */
    #app { padding:20px; max-width:800px; margin:0 auto; min-height:calc(100vh - 60px); }
    h1 { text-align:center; margin-bottom:20px; color:#fff; }

    textarea { width:100%; min-height:100px; padding:10px; border-radius:8px; border:2px solid #333; background:#1e1e1e; color:#fff; margin-bottom:10px; }
    button { width:100%; padding:12px; border:none; border-radius:8px; margin-bottom:10px; background:#4CAF50; color:#fff; cursor:pointer; }
    ul { list-style:none; padding:0; margin-top:10px; }
    li { background:rgba(255,255,255,0.05); margin:5px 0; padding:8px 10px; border-radius:5px; }

    footer { text-align:center; padding:15px; color:#888; font-size:14px; }
    footer .hint { color:#4CAF50; font-size:13px; }
  </style>
</head>
<body>

  <div class="header-bar">
    <select id="languageSelect" onchange="handleLanguageChange(event)">
      <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
      <option value="en">English</option>
    </select>
    <button class="debug-btn" onclick="console.log(currentState)">ğŸ</button>
  </div>

  <main id="app"></main>

  <footer>
    <p>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ | Advanced App Builder</p>
    <p class="hint">Ø¯Ø³ØªÙˆØ±Ø§Øª: "screen note" ÛŒØ§ "ØµÙØ­Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª" ÛŒØ§ "plugin weather"</p>
  </footer>

  <!-- ===== ENGINE.JS ===== -->
  <script>
    const ALLOWED_SCREENS = new Set(["home","note","list"]);

    function normalize(cmd){
      if(typeof cmd!=="string") return "";
      return cmd.toLowerCase()
        .replace(/ØµÙØ­Ù‡/g,"screen")
        .replace(/ÛŒØ§Ø¯Ø¯Ø§Ø´Øª/g,"note")
        .replace(/Ù„ÛŒØ³Øª/g,"list")
        .replace(/Ø¨Ø±Ùˆ/g,"go")
        .replace(/Ø³Ù„Ø§Ù…/g,"alert Ø³Ù„Ø§Ù…")
        .trim();
    }

    function runEngine(input){
      let screen="home", alertText=null, pluginCommand=null;
      if(typeof input==="string" && input.trim()!==""){
        const lines = input.split("\n").map(l=>normalize(l)).filter(Boolean);
        lines.forEach(line=>{
          const parts=line.split(" "), cmd=parts[0];
          if((cmd==="screen"||cmd==="go")&&parts[1]&&ALLOWED_SCREENS.has(parts[1])) screen=parts[1];
          if(cmd==="alert") alertText=parts.slice(1).join(" ");
          if(cmd==="plugin"&&parts[1]) pluginCommand=parts.slice(1).join(" ");
        });
      }
      return { schema:getScreenSchema(screen), meta:{alertText, pluginCommand, currentScreen:screen} };
    }

    function getScreenSchema(screen){
      if(screen==="note") return { title:"note", components:[
        { type:"textarea", id:"noteText", placeholder:"note" },
        { type:"button", label:"save", action:"saveNote" },
        { type:"button", label:"back", action:"goHomeAction" }
      ]};
      if(screen==="list") return { title:"list", components:[
        { type:"textarea", id:"itemInput", placeholder:"item" },
        { type:"button", label:"add", action:"addItem" },
        { type:"list", id:"itemsList"},
        { type:"button", label:"back", action:"goHomeAction"}
      ]};
      return { title:"home", components:[
        { type:"textarea", id:"commandInput", placeholder:"commands" },
        { type:"button", label:"execute", action:"runCommand" }
      ]};
    }

    window.runEngine=runEngine;
  </script>

  <!-- ===== MAIN.JS ===== -->
  <script>
    let currentState=null;
    let history=[];
    const MAX_HISTORY=50;
    const ALLOWED_ACTIONS=new Set(["runCommand","goHomeAction","saveNote","addItem"]);

    function sanitize(text){ const div=document.createElement("div"); div.textContent=text||""; return div.innerHTML; }

    function getNote(){ return sanitize(localStorage.getItem("note")||""); }
    function getList(){ try{ const items=JSON.parse(localStorage.getItem("items")||"[]"); return Array.isArray(items)?items.map(sanitize):[] }catch{return []} }

    window.addEventListener("DOMContentLoaded",()=>runApp("home"));

    function runApp(input){
      history.push({input, ts:new Date().toISOString()});
      if(history.length>MAX_HISTORY) history.shift();
      currentState=window.runEngine(input||"");
      render(currentState);

      if(currentState.meta.alertText) setTimeout(()=>alert(currentState.meta.alertText),50);
      if(currentState.meta.pluginCommand && window.PluginSystem){
        const result=window.PluginSystem.execute(currentState.meta.pluginCommand);
        setTimeout(()=>alert(result),100);
      }
    }

    function render(state){
      const app=document.getElementById("app");
      if(!app||!state||!state.schema) return;
      app.innerHTML="";
      state.schema.components.forEach(c=>{
        if(c.type==="textarea"){
          const t=document.createElement("textarea"); t.id=c.id; t.placeholder=c.placeholder;
          if(c.id==="noteText") t.value=getNote();
          if(c.id==="itemInput") t.value="";
          app.appendChild(t);
        }
        if(c.type==="button"){
          const b=document.createElement("button"); b.textContent=c.label; b.onclick=()=>handleAction(c.action); app.appendChild(b);
        }
        if(c.type==="list"){
          const ul=document.createElement("ul");
          getList().forEach((item,i)=>{ const li=document.createElement("li"); li.textContent=`${i+1}. ${item}`; ul.appendChild(li); });
          app.appendChild(ul);
        }
      });
    }

    function handleAction(action){
      if(!ALLOWED_ACTIONS.has(action)) return;
      if(action==="runCommand"){ const cmd=document.getElementById("commandInput")?.value||""; runApp(cmd); }
      if(action==="goHomeAction") runApp("home");
      if(action==="saveNote"){ const val=document.getElementById("noteText")?.value||""; localStorage.setItem("note",val); alert("Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…"); }
      if(action==="addItem"){ const val=document.getElementById("itemInput")?.value||""; if(!val) return; const list=getList(); if(list.length>=100) return alert("Ø­Ø¯Ø§Ú©Ø«Ø± Û±Û°Û° Ø¢ÛŒØªÙ… Ù…Ø¬Ø§Ø² Ø§Ø³Øª"); list.push(val); localStorage.setItem("items",JSON.stringify(list)); render(currentState);}
    }

    function handleLanguageChange(event){ const val=event.target.value; alert("Ø²Ø¨Ø§Ù† Ø¨Ù‡ "+val+" ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!"); }
  </script>

  <!-- ===== PLUGIN-SYSTEM.JS ===== -->
  <script>
    class PluginSystem{
      constructor(){ this.plugins=new Map(); }
      register(plugin){ if(!plugin.name) return false; this.plugins.set(plugin.name,plugin); return true; }
      execute(name,...args){ const plugin=this.plugins.get(name); if(!plugin) return "Ù¾Ù„Ø§Ú¯ÛŒÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯"; try{ return plugin.execute(...args) }catch{return "Ø®Ø·Ø§ Ø¯Ø± Ù¾Ù„Ø§Ú¯ÛŒÙ†"; } }
      getAll(){ const list=[]; this.plugins.forEach(p=>list.push({name:p.name,description:p.description||"Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­",icon:p.icon||"ğŸ”Œ"})); return list; }
    }
    window.PluginSystem=new PluginSystem();
  </script>

</body>
</html>
